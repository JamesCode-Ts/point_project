<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horas Trabalhadas</title>
    <link rel="stylesheet" type="text/css" href="/point_project/css/style.css">

    <!-- Biblioteca jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  
  <!-- CDN do BootTrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    
    <!-- Biblioteca inputmask -->
<script src="https://rawgit.com/RobinHerbots/Inputmask/5.x/dist/jquery.inputmask.min.js"></script>
      
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Horas Trabalhadas</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </nav>
 <div class ="container">
    <div id="erroCalc" class="alert alert-danger" style="display:none; margin-top: 10px;">
            <strong>Erro!</strong> O Erro ao calcular atrasos e horas extras.
    </div>
    <div class="tabela-horario">

        <form id="userForm1" class="form-group">
            <label for="entrada" style="margin-top:5px" class="form-label">Horário de Trabalho:</label>
           <div class="row">
    <div class="col d-flex align-items-center">
        <label for="entrada" style="margin-top:5px; margin-right: 5px;" class="form-label">Entrada:</label>
<input type="text" class="form-control" id="entrada"  placeholder="HH:00" aria-label="First name" required maxlength="5">
    </div>
    <div class="col d-flex align-items-center">
        <label for="saida" style="margin-top:5px; margin-right: 5px;" class="form-label">Saída:</label>
        <input type="text" class="form-control" id="saida" placeholder="HH:00" aria-label="Last name" required maxlength="5">
    </div>

            <button type="button" id="cadastrarHorario" class="btn btn-primary">Cadastrar</button>
            <button type="button" id="limparTabela1"  style="margin-left: 6px;" class="btn btn-secondary">Limpar Tabela</button>
            <button type="button" id="limparTela"  style="margin-left: 6px;" class="btn btn-danger">Limpar Tela</button>
            </div>
        </form>

      <!-- Adiciona a div para a mensagem de erro -->
      <div id="erroMensagemT" class="alert alert-danger" style="display:none; margin-top: 10px;">
            <strong>Erro!</strong> O formato da hora está incorreto. Use o formato HH:00.
    </div>
        <!-- Adiciona a div para a mensagem de aviso -->
   <div id="limiteAtingido" class="alert alert-warning" style="display:none; margin-top: 10px;">
    <strong>Aviso!</strong> Limite de 3 registros atingido!
  </div>
  
   <div id="CampoVazioT1" class="alert alert-warning" style="display:none; margin-top: 10px;">
    <strong>Aviso!</strong> Campos vazios, digite algum valor. 
  </div>
  <div id="HorarioExiste" class="alert alert-warning" style="display:none; margin-top: 10px;">
    <strong>Aviso!</strong> Horario já exite!
  </div>  

        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Registros</th>
                    <th scope="col">Entrada</th>
                    <th scope="col">Saída</th>
                </tr>
            </thead>
            <tbody id="tabelaRegistrosT1">
                <!-- Os registros serão adicionados aqui dinamicamente -->
            </tbody>
        </table>

    </div>
    <div class="tabela-marcacao">

        <form id="userForm2">
            <label for="exampleFormControlInput1" style="margin-top:5px" class="form-label">Marcações Feitas:</label>
              <div class="row">
    <div class="col d-flex align-items-center">
        <label for="entrada" style="margin-top:5px; margin-right: 5px;" class="form-label">Entrada:</label>
        <input type="text" class="form-control" id="entradaT2" placeholder="HH:00" aria-label="First name" required maxlength="5">
    </div>
    <div class="col d-flex align-items-center">
        <label for="saida" style="margin-top:5px; margin-right: 5px;" class="form-label">Saída:</label>
        <input type="text" class="form-control" id="saidaT2" placeholder="HH:00" aria-label="Last name" required maxlength="5">
    </div>
                  <button type="button" id="cadastrarMarcacao" class="btn btn-primary">Cadastrar</button>
                    <button type="button" id="limparTabela2"  style="margin-left: 6px;" class="btn btn-secondary">Limpar Tabela</button>
                    
            </div>
          
        </form>
        
           <div id="CampoVazioT2" class="alert alert-warning" style="display:none; margin-top: 10px;">
    <strong>Aviso!</strong> Campos vazios, digite algum valor. 
  </div>
        
          <!-- Adiciona a div para a mensagem de erro -->
        <div id="erroMensagemM" class="alert alert-danger" style="display:none; margin-top: 10px;">
            <strong>Erro!</strong> O formato da hora está incorreto. Use o formato HH:00.
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Registros</th>
                    <th scope="col">Entrada</th>
                    <th scope="col">Saída</th>
                </tr>
            </thead>
            <tbody id="tabelaRegistrosT2">
                <!-- Os registros serão adicionados aqui dinamicamente -->
            </tbody>
        </table>
    </div>
 <div class="container-atraso">
     <label  style="margin-top:5px" class="form-label">Atrasos:</label>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Atraso</th>
                <th scope="col">Entrada</th>
                <th scope="col">Saída</th>
            </tr>
        </thead>
        <tbody id="tabelaAtraso">
            <!-- Os registros serão adicionados aqui dinamicamente -->
        </tbody>
    </table>
</div>
 <div class="container-atraso">
      <label  style="margin-top:5px" class="form-label">Horas Extras:</label>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Hora Extra</th>
                <th scope="col">Entrada</th>
                <th scope="col">Saída</th>
            </tr>
        </thead>
        <tbody id="tabelaHoraExtra">
            <!-- Os registros serão adicionados aqui dinamicamente -->
        </tbody>
    </table>
</div>
</div>
  
<!-- Rodapé -->
<footer class="footer fixed-bottom bg-light">
  <div class="containerFooter">
    <span class="text-muted"></span>
  </div>
</footer>

  
<script>

document.getElementById('limparTela').addEventListener('click', function() {
    location.reload(true);
});


    // Função para validar o formato HH:00
    function validarFormatoHora(hora) {
        var regexHora = /^(?:2[0-3]|[01][0-9]):00$/;
        return regexHora.test(hora);
    }
    
    

//Variável para armazenar os registros cadastrados na Tabela 1
let Tabela1 = [];

function cadastrarHorario() {
	
	let entradaCampo = $("#entrada").val();
	
    
    	//Verifica se o campo esta vazio, serve para não salvar um array vazio.
    	if($.trim(entradaCampo) == '') {   		
    		$("#CampoVazioT1").fadeIn(300).delay(3000).fadeOut(300);
    	}else	
        if (Tabela1.length < 3){
         let entrada = $('#entrada').val();
         let saida = $('#saida').val();
             
 
        // Verifica se o novo registro já existe na tabela
        const registroExistente = Tabela1.find(registro => registro.entrada === entrada && registro.saida === saida);

        if (registroExistente) {
          //  alert("Horário já existe!");
        	// Se o formato estiver incorreto, exibe a mensagem de aviso com animação Bootstrap
        	$("#HorarioExiste").fadeIn(300).delay(3000).fadeOut(300);

        } else {
            // Valida os formatos de entrada e saída
            if (validarFormatoHora(entrada) && validarFormatoHora(saida)) {
                // Cria um objeto com os dados do formulário
                const novoRegistroT1 = {
                    entrada: entrada,
                    saida: saida
                };

                // Adiciona o novo registro à tabela
                Tabela1.push(novoRegistroT1);
                
                

                limparCamposT1();
                // Atualiza a exibição dos registros
                exibirRegistrosTabela1();
                $("#erroMensagemT").hide();
            } else {
              //  alert('Formato de hora inválido! Use o formato HH:00.');
                $("#erroMensagemT").show();
            }
        }
    } else {
       // alert('Limite de 3 registros atingido!');
    	$("#limiteAtingido").fadeIn(300).delay(3000).fadeOut(300);
    }
}

// Função para validar o formato HH:00
function validarFormatoHora(hora) {
    const regexHora =/^(2[0-3]|[01]?[0-9]):[0-5][0-9]$/;
    return regexHora.test(hora);
}

function exibirRegistrosTabela1() {
	  // Limpa a exibição atual da tabela
	  $('#tabelaRegistrosT1').empty();

	  // Exibe os registros na tabela
	   Tabela1.forEach((registro, index) => {
	    let numeroLinha = index + 1;
	    $('#tabelaRegistrosT1').append(`
	      <tr>
	        <th scope="row">${numeroLinha}</th>
	        <td>${registro.entrada}</td>
	        <td>${registro.saida}</td>
	      </tr>
	    `);
	  });
	}
	
	
function exibirRegistrosTabela2() {
	  // Limpa a exibição atual da tabela
	//  $('#tabelaRegistrosT2').empty();

	  // Exibe os registros na tabela
	   Tabela2.forEach((registro, index) => {
	    let numeroLinha = index + 1;
	    $('#tabelaRegistrosT2').append(`
	      <tr>
	        <th scope="row">${numeroLinha}</th>
	        <td>${registro.entrada}</td>
	        <td>${registro.saida}</td>
	      </tr>
	    `);
	  });
	}
	
	
let Tabela2 = [];
function cadastrarMarcacao() {
   

	let entradaCampo = $("#entradaT2").val();
	 
    	//Verifica se o campo esta vazio, serve para não salvar um array vazio.
    	if($.trim(entradaCampo) == '') {
    		
    		$("#CampoVazioT2").fadeIn(300).delay(3000).fadeOut(300);
    		
    	}else if(Tabela2.length >= 0){
    		
    	
   $('#tabelaHorasExtras').empty();
        let entrada = $('#entradaT2').val();
        let saida = $('#saidaT2').val();
        
    // Valida os formatos de entrada e saída
    if (validarFormatoHora(entrada) && validarFormatoHora(saida)) {
        // Cria um objeto com os dados do formulário
        const novoRegistroT2 = {
            entrada: entrada,
            saida: saida
        
        }
        // Adiciona o novo registro à lista
        Tabela2.push(novoRegistroT2);

        limparCamposT2();
        // Atualiza a exibição dos registros
        exibirRegistrosTabela2();
        //Chamada da função para calcular atrasos e horas extras
        calcularAtrasoHorasExtras();
        $("#erroMensagemM").hide();
    } else {
      // alert('Formato de hora inválido! Use o formato HH:00.');
        $("#erroMensagemM").show();
    }           
}
    	
}


function limparCamposT2() {
    $('.form-control').val('');
}

function limparCamposT1() {
    $('.form-control').val('');
}


// limpar dados das tabelas,tanto em tela quanto no array
function limparTabela1(){   
	 Tabela1 = []
   $('#tabelaRegistrosT1').empty();	 	     
}
function limparTabela2(){	
	 Tabela2 = []
	$('#tabelaRegistrosT2').empty(); 	
}

$('#limparTabela1').click(function() {
limparTabela1()
});

$('#limparTabela2').click(function() {
limparTabela2()
});



//Evento de clique no botão Cadastrar
$('#cadastrarHorario').click(function() {
  cadastrarHorario();
});

//Evento de clique no botão Cadastrar
$('#cadastrarMarcacao').click(function() {
	cadastrarMarcacao();
});

//Definir variáveis globais para armazenar os resultados
let resultadoAtrasos = [];
let resultadoHorasExtras = [];
function calcularAtrasoHorasExtras() {
    // Verificar se as tabelas estão definidas
    if (Tabela1 && Tabela2) {
        // Construir objeto com os dados das tabelas
        // Construir arrays com os dados das tabelas
        let tabelaHorario = Tabela1.map(objeto => `${objeto.entrada}-${objeto.saida}`);
        let tabelaMarcacoes = Tabela2.map(objeto => `${objeto.entrada}-${objeto.saida}`);
      //  

    $.ajax({
    type: "POST",
    url: "calcularHoras",
    data: {
        tabelaHorario: JSON.stringify(tabelaHorario),
        tabelaMarcacoes: JSON.stringify(tabelaMarcacoes)
    },
    
    
    success: function(data) {
         
    	if(data){
    			
            resultadoAtrasos = data.atrasos;      
          // Exibir os resultados nas tabelas
            tabelaAtraso(resultadoAtrasos);
        
        	resultadoHorasExtras = data.horasExtras;	
               
            tabelaHoraExtra(resultadoHorasExtras);
    	}else{
    		
    		alert('Nenhum retorno do back-end.')
    	}
    },
    error: function() {
    	
    	 $("#erroCalc").show();
      //  alert('Erro ao calcular atrasos e horas extras.');
    }
});

// Função para exibir resultados na tabela de atraso
function tabelaAtraso(resultadoAtrasos) {
    // Limpar a exibição atual da tabela de atrasos
    $('#tabelaAtraso').empty();

    // Verificar se resultadoAtrasos é um array antes de exibi-lo
    if (Array.isArray(resultadoAtrasos)) {
        // Adicionar as novas linhas à tabela de atrasos
        resultadoAtrasos.forEach((atraso) => {
            // Dividir a string em horarioInicio e horarioFim
            let [horarioInicio, horarioFim] = atraso.split(' ');

            // Adicionar a nova linha à tabela de atrasos
            $('#tabelaAtraso').append(`
                <tr>
            	    <th scope="row">#</th>
                    <td>${horarioInicio}</td>
                    <td>${horarioFim}</td>
                </tr>
            `);
        });
    } else {
        console.error('Os dados de atrasos não são um array:', resultadoAtrasos);
        alert('Erro ao processar os dados de atrasos.');
    }
}



//Função para exibir resultados na tabela de horas extras
function tabelaHoraExtra(resultadoHorasExtras) {
 // Limpar a exibição atual da tabela de horas extras
 $('#tabelaHorasExtras').empty();
 if (Array.isArray(resultadoHorasExtras)) {
 // Exibir os resultados na tabela de horas extras
	  resultadoHorasExtras.forEach((horasExtras) => {
          // Dividir a string em horarioInicio e horarioFim
          let [horarioInicio, horarioFim] = horasExtras.split(' ');

          // Adicionar a nova linha à tabela de atrasos
          $('#tabelaHoraExtra').append(`
              <tr>
          	    <th scope="row">#</th>
                  <td>${horarioInicio}</td>
                  <td>${horarioFim}</td>
              </tr>
          `);
      });
}
}
    // Função para formatar uma data
    function formatDate(date) {
        var options = { hour: 'numeric', minute: 'numeric' };
        return new Date(date).toLocaleTimeString('pt-BR', options);
    }

    }
    }
</script>
</body>
</html>
